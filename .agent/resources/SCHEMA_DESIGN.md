# TIED: Supabase Database Schema Design

This document details the database architecture for the **TIED (Transparent, Integrated, Evidence-Driven)** Agentic Valuation Platform.

## Core Architecture: "The Hybrid Vault"
We leverage **PostgreSQL** on Supabase to combine:
1.  **Relational Integrity**: For strict financial reporting and balancing.
2.  **JSONB Flexibility**: For "Agent Reasoning" and audit trails.
3.  **Vector Search**: For "Evidence-Driven" PDF retrieval.

---

## 1. Schema Overview

### A. Static Entities & Time
| Table | Description |
| :--- | :--- |
| **`companies`** | The anchor entity. Stores Ticker (`F`), Name (`Ford`), and Sector. |
| **`financial_periods`** | The time dimension. Unique constraint on `(company_id, fiscal_year, period_type)`. |

### B. The Valuation Engine (Core)
| Table | **`fsap_model_versions`** |
| :--- | :--- |
| **Purpose** | Stores the "Golden Copy" of a valuation model version (Draft, Final). |
| **Financial Cols** | `revenue`, `cogs`, `net_income`, `total_assets`, etc. (Numeric, Flattened). |
| **Lineage Col** | `lineage_map` (JSONB). **MANDATORY for TIED**. Stores the "Why" behind every number. |
| **RLS** | Enabled. Users can only edit models they own. |

### C. The Evidence Engine (RAG)
| Table | Description |
| :--- | :--- |
| **`source_documents`** | Metadata for uploaded PDFs. Links to Supabase Storage bucket `financial_docs`. |
| **`document_chunks`** | Stores split text + `embedding` (vector-1536). Used for semantic search. |

### D. The Assumption Layer (Dual-Track)
| Table | Description |
| :--- | :--- |
| **`extracted_assumptions`** | Read-only signals from 8-K/10-Qs. (e.g., Guidance). |
| **`user_assumptions`** | User's active overrides. Drives the live model. |
| **`parameter_change_log`** | The "Time Machine". Logs every param change for rollback. |

---

## 2. Table Specifications

### `companies`
```sql
CREATE TABLE companies (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  ticker TEXT UNIQUE NOT NULL,
  company_name TEXT NOT NULL,
  currency TEXT DEFAULT 'USD'
);
```

### `financial_periods`
```sql
CREATE TABLE financial_periods (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  company_id BIGINT REFERENCES companies(id),
  fiscal_year INTEGER NOT NULL,
  period_type TEXT NOT NULL, -- 'FY', 'Q3'
  end_date DATE NOT NULL
);
```

### `fsap_model_versions` (The Hybrid Table)

> âš ï¸ **Scenario Isolation**: Each model version belongs to ONE scenario within a Case. Changes in "Bear" never affect "Bull".

```sql
CREATE TABLE fsap_model_versions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  scenario_id UUID REFERENCES valuation_scenarios(id) NOT NULL, -- ğŸ”’ Scenario-scoped
  case_id UUID REFERENCES valuation_cases(id) NOT NULL,
  company_id BIGINT REFERENCES companies(id),
  period_id BIGINT REFERENCES financial_periods(id),
  
  -- Version Control
  version_number INTEGER DEFAULT 1,
  parent_version_id UUID REFERENCES fsap_model_versions(id),
  is_current BOOLEAN DEFAULT TRUE,
  
  -- Financials (Strict Types)
  revenue NUMERIC(20, 2),
  cogs NUMERIC(20, 2),
  net_income NUMERIC(20, 2),
  total_assets NUMERIC(20, 2),
  total_liabilities NUMERIC(20, 2),
  total_equity NUMERIC(20, 2),
  
  lineage_map JSONB DEFAULT '{}'::JSONB,
  
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_fsap_models_scenario ON fsap_model_versions(scenario_id);
```

### `source_documents` & `document_chunks`

> ğŸ“Œ **Note**: These are for RAG/semantic search. For file tracking, use `uploaded_files`.

```sql
CREATE TABLE source_documents (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  case_id UUID REFERENCES valuation_cases(id),  -- ğŸ”’ Case-scoped
  uploaded_file_id UUID REFERENCES uploaded_files(id),  -- Link to file registry
  file_name TEXT NOT NULL,
  storage_path TEXT NOT NULL,
  filing_type TEXT CHECK (filing_type IN ('10-K', '10-Q', '8-K', 'OTHER')),
  filing_date DATE,
  period_end_date DATE
);

CREATE TABLE document_chunks (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  document_id UUID REFERENCES source_documents(id),
  content TEXT,
  embedding vector(1536) -- For OpenAI Embeddings
);
```

### `user_assumptions` & `golden_assumptions`

> ğŸ’¡ **Assumption Hierarchy (Lookup Chain)**:
> 1.  **Case Overrides** (`user_assumptions`): Highest priority, specific to one analysis.
> 2.  **Golden Defaults** (`golden_assumptions`): Admin-verified "best guess" shared across users.
> 3.  **Extracted Context** (`extracted_assumptions`): Raw signals from filings (Item 7 guidance).

```sql
-- Golden Assumptions: The "TIED Default" for a company
CREATE TABLE golden_assumptions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  company_id BIGINT REFERENCES companies(id) NOT NULL,
  
  -- The Assumption
  key TEXT NOT NULL,                 -- 'revenue_growth_2024', 'terminal_growth'
  value NUMERIC,
  rationale TEXT,                    -- Evidence for this default
  
  -- Metadata
  approved_by UUID REFERENCES auth.users(id),
  as_of_date DATE DEFAULT CURRENT_DATE,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  
  UNIQUE(company_id, key)
);

-- Extracted Signals (Evidence)
CREATE TABLE extracted_assumptions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  case_id UUID REFERENCES valuation_cases(id) NOT NULL,
  company_id BIGINT REFERENCES companies(id),
  source_doc_id UUID REFERENCES source_documents(id),
  key TEXT NOT NULL,                -- 'revenue_growth_guidance'
  value NUMERIC,
  context_text TEXT,                -- 'Management expects 15% growth'
  created_at TIMESTAMP DEFAULT NOW()
);

-- User Assumptions: Scenario-specific overrides
-- Scenarios follow a delegation lookup:
-- If key exists in current scenario -> use it.
-- Else if key exists in 'Base' scenario -> use it.
-- Else -> use Golden Default.
CREATE TABLE user_assumptions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  case_id UUID REFERENCES valuation_cases(id) NOT NULL,
  scenario_id UUID REFERENCES valuation_scenarios(id) NOT NULL,
  model_version_id UUID REFERENCES fsap_model_versions(id),
  
  key TEXT NOT NULL,
  value NUMERIC,
  rationale TEXT,
  
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  
  UNIQUE(scenario_id, key)
);

CREATE TABLE parameter_change_log (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  case_id UUID REFERENCES valuation_cases(id) NOT NULL,
  scenario_id UUID REFERENCES valuation_scenarios(id) NOT NULL, -- ğŸ”’ Scenario-specific audit
  user_assumption_id UUID REFERENCES user_assumptions(id),
  
  key TEXT NOT NULL,                -- The parameter key (e.g., 'wacc')
  old_value NUMERIC,
  new_value NUMERIC,
  changed_at TIMESTAMP DEFAULT NOW(),
  changed_by UUID REFERENCES auth.users(id),
  actor_type TEXT CHECK (actor_type IN ('user', 'agent', 'system')),
  reason TEXT,                      -- Rationale for change
  revert_id BIGINT                  -- For rollbacks
);

CREATE INDEX idx_param_changes_scenario ON parameter_change_log(scenario_id, changed_at DESC);
```


## 3. Security (RLS)
- **Isolation**: `auth.uid() = created_by` ensures analysts cannot see each other's drafts unless shared.
- **Public Data**: `companies` allows public read access for shared tickers.

---

## 4. Document Registry (Phase 1: US Stocks)

### `uploaded_files` - The File Timeline
Tracks all files (user uploads + SEC EDGAR pulls) with full history.

```sql
CREATE TABLE uploaded_files (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  company_id BIGINT REFERENCES companies(id),
  user_id UUID REFERENCES auth.users(id),
  
  -- File Info
  file_name TEXT NOT NULL,
  file_type TEXT CHECK (file_type IN ('EXCEL_MODEL', '10-K', '10-Q', '8-K', 'PROXY', 'CUSTOM_PDF')),
  file_size_bytes BIGINT,
  storage_path TEXT,            -- Supabase Storage path
  
  -- Source Tracking
  source TEXT CHECK (source IN ('USER_UPLOAD', 'SEC_EDGAR', 'LOCAL_SYNC')) NOT NULL,
  sec_accession_number TEXT,    -- SEC unique ID (e.g., "0000037996-24-000012")
  sec_cik TEXT,                 -- Company CIK number
  
  -- Timeline
  uploaded_at TIMESTAMP DEFAULT NOW(),
  filing_date DATE,             -- SEC official filing date
  period_end_date DATE,         -- Fiscal period end (e.g., 2023-12-31)
  
  -- Reuse & Templates
  parent_file_id UUID REFERENCES uploaded_files(id),  -- If derived from another file
  is_template BOOLEAN DEFAULT FALSE,
  
  -- Processing Status
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'processing', 'ready', 'error')),
  error_message TEXT,
  
  -- Metadata (flexible)
  metadata JSONB DEFAULT '{}'::JSONB,
  
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Indexes for timeline queries
CREATE INDEX idx_uploaded_files_company_timeline ON uploaded_files(company_id, uploaded_at DESC);
CREATE INDEX idx_uploaded_files_user ON uploaded_files(user_id);
CREATE INDEX idx_uploaded_files_sec ON uploaded_files(sec_accession_number) WHERE sec_accession_number IS NOT NULL;
```

### `sec_company_mappings` - CIK Lookup Cache
```sql
CREATE TABLE sec_company_mappings (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  company_id BIGINT REFERENCES companies(id) UNIQUE,
  cik TEXT NOT NULL,              -- SEC CIK (10 digits, zero-padded)
  sic_code TEXT,                  -- Industry classification
  business_address JSONB,
  last_synced_at TIMESTAMP DEFAULT NOW()
);
```

### `valuation_params` - Per-Case Valuation Parameters

> âš ï¸ **Case Isolation**: Each case has its own valuation parameters. Changing Beta in Case A does NOT affect Case B.

```sql
CREATE TABLE valuation_params (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  case_id UUID REFERENCES valuation_cases(id) NOT NULL,  -- ğŸ”’ Case-scoped
  company_id BIGINT REFERENCES companies(id),
  
  -- CAPM Inputs
  risk_free_rate NUMERIC(6, 4),    -- e.g., 0.0432 (4.32%)
  market_beta NUMERIC(5, 3),       -- e.g., 1.640
  market_risk_premium NUMERIC(6, 4), -- e.g., 0.0418 (4.18%)
  
  -- Valuation Assumptions
  long_run_growth NUMERIC(6, 4),   -- Terminal growth rate
  wacc NUMERIC(6, 4),              -- Weighted average cost of capital
  cost_of_equity NUMERIC(6, 4),    -- Calculated from CAPM
  cost_of_debt NUMERIC(6, 4),
  tax_rate NUMERIC(5, 4),
  
  -- Metadata
  source TEXT,                      -- 'BLOOMBERG', 'YAHOO', 'MANUAL'
  as_of_date DATE,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_valuation_params_case ON valuation_params(case_id);
```

---

## 5. Valuation Case System

A **Case** is a project container that organizes all files, settings, and timeline for one valuation analysis.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Valuation Case: "Ford FY2023 Analysis"         â”‚
â”‚  case_id: abc123                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  SEC Filings:                                   â”‚
â”‚    â”œâ”€ 10-K (2023) âœ“ Processed                  â”‚
â”‚    â”œâ”€ 10-K (2022) âœ“ Processed                  â”‚
â”‚    â”œâ”€ 10-K (2021) âœ“ Processed                  â”‚
â”‚    â”œâ”€ 10-Q Q3 2023 âœ“ Processed                 â”‚
â”‚    â””â”€ 10-Q Q2 2023 â—‹ Pending                   â”‚
â”‚                                                 â”‚
â”‚  Support Files:                                 â”‚
â”‚    â”œâ”€ Goldman_Model.xlsx                        â”‚
â”‚    â””â”€ Industry_Report.pdf                       â”‚
â”‚                                                 â”‚
â”‚  Timeline:                                      â”‚
â”‚    Jan 18 00:30 - Created case                  â”‚
â”‚    Jan 18 00:32 - Auto-fetched 3x 10-K          â”‚
â”‚    Jan 18 00:45 - Uploaded Goldman model        â”‚
â”‚    Jan 18 01:00 - Data validation passed        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### `valuation_cases` - The Project Container
```sql
CREATE TABLE valuation_cases (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id),
  company_id BIGINT REFERENCES companies(id),
  
  -- ğŸ”’ One case per company per user
  -- To start fresh, the user must archive/delete the old case.
  UNIQUE(user_id, company_id),

  -- Case Info
  case_name TEXT NOT NULL,
  description TEXT,
  status TEXT DEFAULT 'draft' CHECK (status IN ('draft', 'in_progress', 'ready', 'archived')),
  
  -- Coverage Settings
  fiscal_years INTEGER[],
  include_quarters BOOLEAN DEFAULT FALSE,
  quarters TEXT[],
  
  active_model_version_id UUID,
  
  -- Timestamps
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  completed_at TIMESTAMP
);
```

### `valuation_scenarios` - Scenarios within a Case

```sql
CREATE TABLE valuation_scenarios (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  case_id UUID REFERENCES valuation_cases(id) NOT NULL,
  
  name TEXT NOT NULL,                -- "Base", "Bull", "Bear"
  type TEXT CHECK (type IN ('base', 'bull', 'bear', 'custom')),
  description TEXT,
  
  -- Multi-Scenario Settings
  is_active BOOLEAN DEFAULT TRUE,
  
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### `advanced_analysis` - Sensitivity & Monte Carlo

```sql
CREATE TABLE fsap_model_versions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  case_id UUID REFERENCES valuation_cases(id) NOT NULL,
  scenario_id UUID REFERENCES valuation_scenarios(id) NOT NULL,
  
  -- ğŸš© Metadata
  version_tag TEXT,                 -- e.g., "Pre-Earnings", "Final V1"
  is_milestone BOOLEAN DEFAULT FALSE, -- ğŸ”’ Protects from auto-pruning
  
  -- Data Snapshot (JSONB)
  model_data JSONB NOT NULL,        -- Complete FSAP Input state
  output_results JSONB,             -- Cached NPV, Ratios, etc.
  
  created_at TIMESTAMP DEFAULT NOW(),
  created_by UUID REFERENCES auth.users(id)
);

CREATE TABLE sensitivity_results (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  case_id UUID REFERENCES valuation_cases(id),
  scenario_id UUID REFERENCES valuation_scenarios(id),
  
  variable_key TEXT,                 -- "wacc", "long_term_growth"
  variable_range NUMERIC[],          -- {-0.01, 0, +0.01}
  output_values JSONB,               -- Map range values to resulting NPV
  
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE monte_carlo_results (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  case_id UUID REFERENCES valuation_cases(id),
  scenario_id UUID REFERENCES valuation_scenarios(id),
  
  iterations INTEGER DEFAULT 1000,
  distribution_summary JSONB,        -- { "p10": 100, "p50": 120, "p90": 150 }
  raw_results NUMERIC[],             -- All iteration results
  
  created_at TIMESTAMP DEFAULT NOW()
);
```

### Update `uploaded_files` - Link to Case
```sql
ALTER TABLE uploaded_files ADD COLUMN case_id UUID REFERENCES valuation_cases(id);
CREATE INDEX idx_uploaded_files_case ON uploaded_files(case_id);
```

### `case_timeline` - Activity Log with Lineage
```sql
CREATE TABLE case_timeline (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  case_id UUID REFERENCES valuation_cases(id) NOT NULL,
  
  -- Event Info
  event_type TEXT NOT NULL CHECK (event_type IN (
    'case_created',
    'file_added',
    'file_processed',
    'data_extracted',
    'validation_passed',
    'validation_failed',
    'model_updated',
    'assumption_changed',
    'user_comment',
    'assumption_overridden',
    'golden_promoted'
  )),
  
  -- References (polymorphic)
  file_id UUID REFERENCES uploaded_files(id),
  model_version_id UUID,
  
  -- Details
  description TEXT,
  metadata JSONB DEFAULT '{}'::JSONB,  -- Flexible event data
  
  -- Actor
  actor_type TEXT CHECK (actor_type IN ('user', 'agent', 'system')),
  actor_id TEXT,  -- User ID or Agent name
  
  -- Time
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_case_timeline_case ON case_timeline(case_id, created_at DESC);
```

### `data_lineage` - Track Data Origin (Precise Location)
```sql
CREATE TABLE data_lineage (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  case_id UUID REFERENCES valuation_cases(id),
  
  -- What data point
  field_path TEXT NOT NULL,           -- "balance_sheet.total_assets.2023"
  field_value NUMERIC,
  
  -- Where it came from (coarse)
  source_file_id UUID REFERENCES uploaded_files(id),
  source_section TEXT,                -- "item_8"
  source_page INTEGER,
  source_excerpt TEXT,                -- Original text snippet
  
  -- Where it came from (precise) ğŸ”
  source_note_number TEXT,            -- "Note 12", "Note 2A"
  source_paragraph INTEGER,           -- Paragraph # within section
  source_char_start INTEGER,          -- Character offset start
  source_char_end INTEGER,            -- Character offset end
  source_table_ref TEXT,              -- "Table 12.1" if from table
  
  -- How it was extracted
  extraction_method TEXT CHECK (extraction_method IN ('xbrl', 'agent_ocr', 'user_input', 'calculated')),
  confidence NUMERIC(3, 2),           -- 0.00 - 1.00
  
  -- Validation
  is_verified BOOLEAN DEFAULT FALSE,
  verified_by UUID REFERENCES auth.users(id),
  verified_at TIMESTAMP,
  
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_data_lineage_case ON data_lineage(case_id);
CREATE INDEX idx_data_lineage_field ON data_lineage(field_path);
CREATE INDEX idx_data_lineage_note ON data_lineage(source_note_number) WHERE source_note_number IS NOT NULL;
```

---

## 6. Workflow: Creating a Valuation Case

```sql
-- 1. User creates a new case
INSERT INTO valuation_cases (user_id, company_id, case_name, fiscal_years)
VALUES ('user-uuid', 1, 'Ford FY2023 Valuation', ARRAY[2021, 2022, 2023]);

-- 2. System auto-fetches SEC filings
INSERT INTO uploaded_files (case_id, company_id, file_name, file_type, source, ...)
VALUES ('case-uuid', 1, 'Ford_10K_2023.htm', '10-K', 'SEC_EDGAR', ...);

-- 3. Timeline event logged
INSERT INTO case_timeline (case_id, event_type, file_id, description, actor_type)
VALUES ('case-uuid', 'file_added', 'file-uuid', 'Auto-fetched 10-K for FY2023', 'system');

-- 4. User uploads support file
INSERT INTO uploaded_files (case_id, file_name, file_type, source, ...)
VALUES ('case-uuid', 'Goldman_Model.xlsx', 'EXCEL_MODEL', 'USER_UPLOAD', ...);

-- 5. Data extraction with lineage
INSERT INTO data_lineage (case_id, field_path, field_value, source_file_id, extraction_method)
VALUES ('case-uuid', 'income_statement.revenue.2023', 176000000000, 'file-uuid', 'xbrl');
```

---

## 7. Case Discovery & Cloning

When a user starts a new analysis, the system checks for existing context.

### Scenario Logic (Parameter Delegation)
Instead of cloning the entire model, TIED uses a **Delegation Model** for scenarios:

1. **Base Scenario**: The "Anchor". Contains the full set of user-verified mappings and primary assumptions.
2. **Additional Scenarios (Bull/Bear)**: Only store **Deltas** (overrides).
   - *Example*: Bull scenario only contains `revenue_growth = 0.08`.
   - All other parameters (COGS %, Tax Rate, Historical Data) are inherited from the **Base Scenario**.
3. **Calculation Engine**: When calculating a "Bull" valuation:
   - It fetches Bull-specific parameters.
   - For any missing parameter, it falls back to Base.
   - This works exactly like **Monte Carlo**, where you vary 2-3 key drivers while keeping the rest of the engine stable.

### Case Discovery Logic
1. **Existing Case Check**: When a user enters a Ticker (e.g., "F"), query `valuation_cases` WHERE `user_id = current_user` AND `company_id = ticker_id`.
2. **User Prompt**: If a record is found:
   - "You already have an active Case for Ford Motor Co."
   - "Open Existing Case (Continue Analysis)"
   - "Archive & Start Fresh (Warning: Archive moves current case to history)"

---
---

## 8. Multi-Level Traceability Logic (Audit Trail)

To ensure varied assumptions are fully trackable, TIED implements three layers of audit:

1.  **Macro Level (Case Timeline)**:
    - High-level events in `case_timeline`.
    - *Example*: "Agent updated 12 parameters based on 10-K Item 7."
2.  **Snapshot Level (Model Versions)**:
    - Every calculation triggers a new row in `fsap_model_versions`.
    - Captures the **entire state** of the model (NPV, Drivers, Output).
    - Allows "Time Travel" to see the valuation at any point in history.
3.  **Micro Level (Parameter Change Log)**:
    - Finite tracking in `parameter_change_log`.
    - Records **Old Value vs New Value** for every single field.
    - Includes `actor_type` (User vs Agent) and `reason`.
    - Supports **Atomic Reverts** (Rollbacks).

---
---

## 9. Version Retention & Pruning (Anti-Bloat)

To prevent database explosion while maintaining traceability:

1.  **The "Milestone" Rule**: Only versions explicitly marked `is_milestone = TRUE` by the user (or during major saves) are kept indefinitely.
2.  **Auto-Pruning (LRU)**:
    - For non-milestone "ephemeral" versions, the system only keeps the **last 20 versions** per scenario.
    - Older ephemeral versions are auto-deleted during a background cleanup window.
3.  **Log Persistence**: The `parameter_change_log` is lightweight text and is kept longer than full JSONB snapshots.

## 10. Agent Context Window (How Agent knows what to read)

The Agent uses a **"Truth Pointer"** system to stay synchronized:

1.  **Current Live State**: The Agent always reads the `active_model_version_id` from the `valuation_cases` or `valuation_scenarios` table. This is the "Current Truth".
2.  **Differential Context**: When you ask "Compare with yesterday," the Agent fetches the *nearest* Milestone version and computes a diff.
3.  **Token Efficiency**: The Agent only loads the specific PDF/Excel snippets associated with the parameters currently being discussed, rather than the entire history.

---
